<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jack's Family World Map</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #121821;
        --text: #f6f7fb;
        --muted: #97a2b0;
        --accent: #ff0000; /* arcs - red */
        --accent2: #ffd166; /* markers */
        --accent3: #118ab2; /* hover/focus */
        --danger: #ef476f;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 14px;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }

      /* Top bar */
      .topbar {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 14px clamp(14px, 4vw, 28px);
        background: linear-gradient(
          180deg,
          rgba(18, 24, 33, 0.95) 0%,
          rgba(18, 24, 33, 0.85) 100%
        );
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        position: sticky;
        top: 0; /* keep visible when scrolling */
        z-index: 1000;
        backdrop-filter: blur(6px);
      }

      .title {
        font-size: clamp(18px, 2.4vw, 28px);
        font-weight: 800;
        letter-spacing: 0.3px;
        margin-right: auto;
        user-select: none;
      }

      .control {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--panel);
        padding: 10px 12px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .control label {
        color: var(--muted);
        font-size: 14px;
        user-select: none;
      }
      select {
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: #0f1520;
        color: var(--text);
        padding: 10px 36px 10px 12px;
        font-size: 15px;
        border-radius: 10px;
        outline: none;
        cursor: pointer;
        transition: border-color 0.2s ease;
        background-image: linear-gradient(
            45deg,
            transparent 50%,
            var(--muted) 50%
          ),
          linear-gradient(135deg, var(--muted) 50%, transparent 50%);
        background-position: calc(100% - 18px) calc(50% - 3px),
          calc(100% - 12px) calc(50% - 3px);
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
      }
      select:focus {
        border-color: var(--accent3);
      }

      /* Map container fills the remaining viewport height */
      #map {
        height: calc(100vh - 66px);
        width: 100vw;
        position: relative;
        z-index: 1;
        background: #000000;
      }

      /* Description panel in bottom-left */
      .info-panel {
        position: absolute;
        left: 80px;
        bottom: 16px;
        z-index: 500;
        width: min(420px, 90vw);
        background: rgba(10, 14, 20, 0.86);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 14px 16px 16px;
        color: var(--text);
      }
      .info-panel h3 {
        margin: 6px 0 8px;
        font-size: 18px;
      }
      .info-panel p {
        margin: 0;
        font-size: 14px;
        color: #e5e9f1;
      }

      /* Leaflet tweaks */
      .leaflet-control-zoom a {
        background: var(--panel) !important;
        color: var(--text) !important;
        border: 1px solid rgba(255, 255, 255, 0.12) !important;
      }
      .leaflet-control-zoom a:hover {
        filter: brightness(1.2);
      }

      /* Satellite map styling - no filter needed for natural colors */

      /* Permanent labels under markers */
      .location-label {
        background: rgba(0, 0, 0, 0.7);
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 3px 6px;
        border-radius: 8px;
        font-size: 12px;
        box-shadow: var(--shadow);
      }
      .location-label:before {
        display: none;
      }

      .push-pull-popup .leaflet-popup-content-wrapper {
        background: rgba(10, 14, 20, 0.86);
        color: var(--text);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .push-pull-popup .leaflet-popup-tip {
        background: rgba(10, 14, 20, 0.86);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .push-pull-popup .leaflet-popup-content {
        margin: 12px 16px;
      }
      .push-pull-popup .popup-text {
        font-size: 14px;
        color: #e5e9f1;
        margin: 0;
        line-height: 1.4;
      }
      .push-pull-popup .popup-text div + div {
        margin-top: 4px;
      }

      /* Small helper at bottom-left for instructions */
      .hint {
        position: absolute;
        bottom: 18px;
        left: 16px;
        z-index: 500;
        font-size: 12px;
        color: var(--muted);
        background: rgba(10, 14, 20, 0.7);
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      @media (max-width: 640px) {
        #map {
          height: calc(100vh - 110px);
        }
        .control {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top bar with title & selector -->
    <div class="topbar">
      <div class="title">Jack's Family World Map</div>
      <div class="control">
        <label for="personSelect">Choose a relative:</label>
        <select id="personSelect" aria-label="Select a relative"></select>
      </div>
    </div>

    <!-- Map -->
    <div id="map"></div>
    <div class="info-panel" id="infoPanel">
      <h3 id="personName">Select a relative</h3>
      <p id="personDesc">
        Choose a relative from the dropdown to see their journey.
      </p>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      // ==========================
      // 1) ADD / EDIT FAMILY DATA
      // ==========================
      // Each person has: name, places[], description
      // - The first place is the BIRTH location (it will be labeled '(born)').
      // - Add any number of moves as additional places in order.
      // - Under each location, the label will show the place name.

      const relatives = [
        {
          name: "Tim (Dad)",
          colors: { marker: "#ff6b6b", arc: "#ff4757" }, // Red
          places: [
            {
              name: "Guildford, United Kingdom",
              lat: 51.2357,
              lng: -0.5621,
              factors: "Born",
            },
            {
              name: "Auckland, New Zealand",
              lat: -36.8485,
              lng: 174.7633,
              factors:
                "Push factors: Economy in the UK was bad\nPull factors: Timber mill job for his dad and an outdoor New Zealand lifestyle",
            },
            {
              name: "Oxford, United Kingdom",
              lat: 51.752,
              lng: -1.2577,
              factors:
                "Push factors: Nil\nPull factors: PhD opportunity at Oxford and adventure of living abroad",
            },
            {
              name: "Sydney, Australia",
              lat: -33.8688,
              lng: 151.2093,
              factors:
                "Push factors: Nil\nPull factors: Got a job in Sydney, great lifestyle and close to family in New Zealand",
            },
          ],
          description: `Dad was born in the UK, moved to New Zealand with his family when he was 3 because his father got a job in a timber mill. He then moved to Oxford to study a PhD in neuroscience, married my mum in 2010, and finally moved to Sydney.`,
        },
        {
          name: "Julia (Mum)",
          colors: { marker: "#4ecdc4", arc: "#00d2d3" }, // Teal
          places: [
            {
              name: "Sacramento, United States",
              lat: 39.7138,
              lng: -121.7913,
              factors: "Born",
            },
            {
              name: "Tackley, United Kingdom",
              lat: 51.2357,
              lng: -0.5621,
              factors:
                "Push factors: Nil\nPull factors: Jobs for her parents in Oxford and extended family in England",
            },
            {
              name: "Auckland, New Zealand",
              lat: -36.8485,
              lng: 174.7633,
              factors:
                "Push factors: Looking for new experiences after medical training in the UK\nPull factors: Hospital role in Auckland, Uncle and Aunt in NZ and adventure in New Zealand",
            },
            {
              name: "Oxford, United Kingdom",
              lat: 51.752,
              lng: -1.2577,
              factors:
                "Push factors: Nil\nPull factors: Chance to live near family again and be with Dad  in Oxford",
            },
            {
              name: "Sydney, Australia",
              lat: -33.8688,
              lng: 151.2093,
              factors:
                "Push factors: Nil\nPull factors: Dad's job in Sydney and good weather",
            },
          ],
          description: `Mum was born in Sacramento, California, and moved to Tackley, United Kingdom when she was 3. She grew up in England and then moved to New Zealand where she met my Dad while they were both doctors in a hospital. She moved back to Oxford with my Dad and then they settled in Australia because Dad got a job in Sydney. Mum then finished her training as an anaesthetist.`,
        },
        {
          name: "Papa (Grandfather)",
          colors: { marker: "#45b7d1", arc: "#3742fa" }, // Blue
          places: [
            {
              name: "Esher, United Kingdom",
              lat: 51.2357,
              lng: -0.5621,
              factors: "Born",
            },
            {
              name: "Palmerston North, New Zealand",
              lat: -40.3566,
              lng: 174.7633,
              factors:
                "Push factors: Few chances to run his own farm in England\nPull factors: Affordable land in New Zealand, NZ government paid for his trip and the promise of adventure",
            },
            {
              name: "London, United Kingdom",
              lat: 51.5074,
              lng: -0.1278,
              factors:
                "Push factors: Farming dream in New Zealand proved challenging\nPull factors: Family ties and job opportunity back in London",
            },
            {
              name: "Auckland, New Zealand",
              lat: -36.8485,
              lng: 174.7633,
              factors:
                "Push factors: Economy in the UK was bad\nPull factors: Offer of a timber mill job",
            },
          ],
          description: `Papa was born near London. He moved to New Zealand when he was only 18 on a ship because he wanted to be a farmer. He eventually moved back to London and then back to New Zealand for a job in a timber mill.`,
        },
        {
          name: "Nanna (Grandmother)",
          colors: { marker: "#f9ca24", arc: "#f0932b" }, // Orange/Yellow
          places: [
            {
              name: "London, United Kingdom",
              lat: 51.5074,
              lng: -0.1278,
              factors: "Born",
            },
            {
              name: "Kenya",
              lat: -1.286389,
              lng: 36.817223,
              factors:
                "Push factors: Post-war Britain offered little land for her family\nPull factors: Coffee farm opportunity in Kenya",
            },
            {
              name: "London, United Kingdom",
              lat: 51.5074, 
              lng: -0.1278,
              factors:
                "Push factors: Poor schools in Kenya\nPull factors: Good education opportunities in England",
            },
            {
              name: "San Francisco, United States",
              lat: 37.7749,
              lng: -122.4194,
              factors:
                "Push factors: Nil\nPull factors: Job at university in California",
            },
            {
              name: "Oxford, United Kingdom",
              lat: 51.752,
              lng: -1.2577,
              factors:
                "Push factors: Nil\nPull factors: Professorship in Oxford and being near extended family",
            },
          ],
          description: `Nanna was born in England but her family moved to Kenya to be coffee farmers. She went to boarding school back in England and eventually moved back when she went to university (where she got a PhD in entomology - insects!) She then moved with Grandpa Martin to the USA and then came back to live in Oxford because Grandpa Martin was a Professor there.`,
        },
        {
          name: "Mimmi (Grandmother)",
          colors: { marker: "#6c5ce7", arc: "#a29bfe" }, // Purple
          places: [
            {
              name: "Palmerston North, New Zealand",
              lat: -40.3566,
              lng: 174.7633,
              factors: "Born",
            },
            {
              name: "London, United Kingdom",
              lat: 51.5074,
              lng: -0.1278,
              factors:
                "Push factors: Nil\nPull factors: Papa's job in London",
            },
            {
              name: "Auckland, New Zealand",
              lat: -36.8485,
              lng: 174.7633,
              factors:
                "Push factors: Recession in the UK\nPull factors: Building a life with Papa and living near New Zealand family",
            },
    
          ],
          description: `Mimmi was born in New Zealand where she grew up on a sheep farm. She met Papa and they moved to England for a while and then back to New Zealand where they live now.`,
        },
        {
          name: "Grandpa Martin (Grandfather)",
          colors: { marker: "#fd79a8", arc: "#e84393" }, // Pink
          places: [
            {
              name: "London, United Kingdom",
              lat: 51.5074,
              lng: -0.1278,
              factors: "Born",
            },
            {
              name: "San Francisco, United States",
              lat: 37.7749,
              lng: -122.4194,
              factors:
                "Push factors: Wanted to broaden his academic network\nPull factors: Visiting professorship in California and tech innovation scene",
            },
            {
              name: "Oxford, United Kingdom",
              lat: 51.752,
              lng: -1.2577,
              factors:
                "Push factors: Temporary US research stint finished\nPull factors: Permanent chair at Oxford and a historic college community",
            },
          ],
          description: `Grandpa Martin was born in the UK and aside from some years working in California, he lived there for his whole life.`,
        },
        {
          name: "Auntie Caroline",
          colors: { marker: "#dda0dd", arc: "#d8bfd8" }, // Light Purple
          places: [
            {
              name: "Guildford, United Kingdom",
              lat: 51.2357,
              lng: -0.5621,
              factors: "Born",
            },
            {
              name: "Auckland, New Zealand",
              lat: -36.8485,
              lng: 174.7633,
              factors:
                "Push factors: Recession in the UK\nPull factors: Papa's job in NZ and the promise of a better lifestyle",
            },
            {
              name: "Dubai, United Arab Emirates",
              lat: 25.276987,
              lng: 55.296233,
              factors:
                "Push factors: Nil\nPull factors: Tax-free salary and global adventure and great job offer in Dubai",
            },
            {
              name: "Auckland, New Zealand",
              lat: -36.8485,
              lng: 174.7633,
              factors:
                "Push factors: Far from family and hot desert climate\nPull factors: Returning to New Zealand to start a family closer to parents",
            },
          ],
          description: `Caroline was born in the UK and grew up in New Zealand. She then moved to Dubai for her first job after university and then back to New Zealand to start her family.`,
        },
        {
          name: "Auntie Jennifer",
          colors: { marker: "#00b894", arc: "#00a085" }, // Green
          places: [
            {
              name: "Sacramento, United States",
              lat: 39.7138,
              lng: -121.7913,
              factors: "Born",
            },
            {
              name: "Oxford, United Kingdom",
              lat: 51.752,
              lng: -1.2577,
              factors:
                "Push factors: Nil\nPull factors: Parent's job offers in Oxford",
            },
          ],
          description: `Jennifer was born in California and moved to Oxford because her parents got a job there.`,
        },
      ];

      // ==========================
      // 2) MAP INITIALIZATION
      // ==========================
      const map = L.map("map", {
        zoomControl: false,
        worldCopyJump: false,
        maxBounds: [
          [-85, -180],
          [85, 180],
        ],
        maxBoundsViscosity: 1.0,
        minZoom: 1,
        maxZoom: 18,
        bounceAtZoomLimits: false,
        wheelPxPerZoomLevel: 60,
      });

      // Satellite basemap
      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          attribution:
            '&copy; <a href="https://www.esri.com/">Esri</a> &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
          maxZoom: 18,
          noWrap: true,
          bounds: [
            [-85, -180],
            [85, 180],
          ],
        }
      ).addTo(map);

      L.control.zoom({ position: "bottomleft" }).addTo(map);

      // Prevent map from going beyond world bounds
      map.on("drag", function () {
        const center = map.getCenter();
        const bounds = map.getBounds();

        // If the map is dragged beyond the world bounds, constrain it
        if (bounds.getWest() < -180 || bounds.getEast() > 180) {
          const newLng = Math.max(-180, Math.min(180, center.lng));
          map.setView([center.lat, newLng], map.getZoom(), { animate: false });
        }
      });

      // Additional bounds checking on zoom and move events
      map.on("zoomend moveend", function () {
        const center = map.getCenter();
        const bounds = map.getBounds();

        // Ensure longitude stays within world bounds
        if (center.lng < -180 || center.lng > 180) {
          const newLng = Math.max(-180, Math.min(180, center.lng));
          map.setView([center.lat, newLng], map.getZoom(), { animate: false });
        }

        // Ensure latitude stays within reasonable bounds
        if (center.lat < -85 || center.lat > 85) {
          const newLat = Math.max(-85, Math.min(85, center.lat));
          map.setView([newLat, center.lng], map.getZoom(), { animate: false });
        }
      });

      // Layer groups we reuse per selection
      const markersGroup = L.layerGroup().addTo(map);
      const arcsGroup = L.layerGroup().addTo(map);
      const decoratorsGroup = L.layerGroup().addTo(map);

      // ==========================
      // 3) UTILITIES
      // ==========================

      // Compute great-circle arc points between two LatLngs (spherical linear interpolation)
      function greatCircleArc(a, b, steps = 128, offset = 0) {
        const toRad = (d) => (d * Math.PI) / 180;
        const toDeg = (r) => (r * 180) / Math.PI;

        const φ1 = toRad(a.lat),
          λ1 = toRad(a.lng);
        const φ2 = toRad(b.lat),
          λ2 = toRad(b.lng);

        const v1 = [
          Math.cos(φ1) * Math.cos(λ1),
          Math.cos(φ1) * Math.sin(λ1),
          Math.sin(φ1),
        ];
        const v2 = [
          Math.cos(φ2) * Math.cos(λ2),
          Math.cos(φ2) * Math.sin(λ2),
          Math.sin(φ2),
        ];

        // Angle between vectors
        let dot = v1[0] * v2[0] + v1[1] * v2[1] + v1[2] * v2[2];
        dot = Math.min(1, Math.max(-1, dot));
        const d = Math.acos(dot);

        if (d === 0) return [L.latLng(a.lat, a.lng), L.latLng(b.lat, b.lng)];

        const sinD = Math.sin(d);
        const pts = [];

        for (let i = 0; i <= steps; i++) {
          const t = i / steps;
          const A = Math.sin((1 - t) * d) / sinD;
          const B = Math.sin(t * d) / sinD;
          let x = A * v1[0] + B * v2[0];
          let y = A * v1[1] + B * v2[1];
          let z = A * v1[2] + B * v2[2];

          // Apply subtle offset using a simple lateral displacement
          if (offset !== 0) {
            // Calculate distance between points to scale offset appropriately
            const distance = d; // This is already the angular distance

            // Create a subtle offset that's proportional to the distance
            // Max offset is about 2% of the distance, and it's strongest at the midpoint
            const maxOffset = distance * 0.02 * offset;
            const offsetStrength = Math.sin(Math.PI * t); // Bell curve peaking at midpoint

            // Calculate perpendicular direction (cross product of current point with north pole)
            const north = [0, 0, 1];
            const currentPoint = [x, y, z];
            const perpendicular = [
              currentPoint[1] * north[2] - currentPoint[2] * north[1],
              currentPoint[2] * north[0] - currentPoint[0] * north[2],
              currentPoint[0] * north[1] - currentPoint[1] * north[0],
            ];

            // Normalize perpendicular vector
            const perpLength = Math.sqrt(
              perpendicular[0] * perpendicular[0] +
                perpendicular[1] * perpendicular[1] +
                perpendicular[2] * perpendicular[2]
            );

            if (perpLength > 0) {
              const offsetAmount = maxOffset * offsetStrength;
              x += (perpendicular[0] / perpLength) * offsetAmount;
              y += (perpendicular[1] / perpLength) * offsetAmount;
              z += (perpendicular[2] / perpLength) * offsetAmount;
            }
          }

          const φ = Math.atan2(z, Math.hypot(x, y));
          const λ = Math.atan2(y, x);
          pts.push(L.latLng(toDeg(φ), toDeg(λ)));
        }
        return pts;
      }

      function clearLayers() {
        markersGroup.clearLayers();
        arcsGroup.clearLayers();
        decoratorsGroup.clearLayers();
      }

      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function createPopupContent(factors) {
        if (!factors) return "";

        const trimmed = String(factors).trim();
        if (!trimmed) return "";

        if (trimmed.toLowerCase() === "born") {
          return '<div class="popup-text"><strong>Born</strong></div>';
        }

        const lines = trimmed
          .split(/\n+/)
          .map((line) => line.trim())
          .filter(Boolean);

        const htmlLines = lines.map((line) => {
          const match = line.match(/^(Push factors:|Pull factors:)(.*)$/i);
          if (match) {
            const label = escapeHtml(match[1]);
            const value = escapeHtml(match[2].trim());
            return `<div><strong>${label}</strong> ${value}</div>`;
          }
          return `<div>${escapeHtml(line)}</div>`;
        });

        return '<div class="popup-text">' + htmlLines.join("") + "</div>";
      }

      // Nicely style circle markers
      function addLabeledMarker(lat, lng, label, markerColor = null) {
        const fillColor =
          markerColor ||
          getComputedStyle(document.documentElement)
            .getPropertyValue("--accent2")
            .trim();

        const marker = L.circleMarker([lat, lng], {
          radius: 6,
          color: "#000",
          weight: 2,
          fillColor: fillColor,
          fillOpacity: 1,
        }).addTo(markersGroup);

        marker.bindTooltip(label, {
          permanent: true,
          direction: "bottom",
          className: "location-label",
          offset: [0, 8],
        });

        return marker;
      }

      function addArcWithArrow(from, to, arcColor = null, offset = 0) {
        const arcPoints = greatCircleArc(from, to, 96, offset);

        const lineColor =
          arcColor ||
          getComputedStyle(document.documentElement)
            .getPropertyValue("--accent")
            .trim();

        const poly = L.polyline(arcPoints, {
          color: lineColor,
          weight: 3,
          opacity: 0.9,
        }).addTo(arcsGroup);

        // Build a larger arrowhead centred part-way along the arc to show direction clearly
        if (arcPoints.length >= 2) {
          let tipIndex = Math.floor(arcPoints.length / 2);
          if (tipIndex <= 0) tipIndex = 1;
          if (tipIndex >= arcPoints.length) tipIndex = arcPoints.length - 1;

          const tipLatLng = arcPoints[tipIndex];
          const prevLatLng = arcPoints[tipIndex - 1];

          const tipPoint = map.options.crs.project(tipLatLng);
          const prevPoint = map.options.crs.project(prevLatLng);

          const vx = tipPoint.x - prevPoint.x;
          const vy = tipPoint.y - prevPoint.y;
          const mag = Math.hypot(vx, vy);

          if (mag > 0) {
            const nx = vx / mag;
            const ny = vy / mag;

            const totalDistance = Math.max(
              map.distance([from.lat, from.lng], [to.lat, to.lng]),
              1
            );
            const baseLength = Math.min(
              Math.max(totalDistance * 0.18, 12000),
              500000
            );
            const basePoint = L.point(
              tipPoint.x - nx * baseLength,
              tipPoint.y - ny * baseLength
            );

            const wingScale = baseLength * 0.5;
            const perpX = -ny * wingScale;
            const perpY = nx * wingScale;

            const leftPoint = L.point(
              basePoint.x + perpX,
              basePoint.y + perpY
            );
            const rightPoint = L.point(
              basePoint.x - perpX,
              basePoint.y - perpY
            );

            const arrowHead = L.polygon(
              [
                tipLatLng,
                map.options.crs.unproject(leftPoint),
                map.options.crs.unproject(rightPoint),
              ],
              {
                color: lineColor,
                fillColor: lineColor,
                fillOpacity: 0.9,
                weight: 0,
                interactive: false,
              }
            );

            arrowHead.addTo(decoratorsGroup);
          }
        }

        return poly;
      }

      // ==========================
      // 4) RENDER A PERSON
      // ==========================

      function renderPerson(person) {
        clearLayers();

        const bounds = [];

        // Use the person's assigned colors
        const colors = person.colors;

        // Place markers + labels for each location
        let firstMarker = null;
        let firstPopupReady = false;

        person.places.forEach((p, index) => {
          const marker = addLabeledMarker(p.lat, p.lng, p.name, colors.marker);

          if (p.factors) {
            const popupContent = createPopupContent(p.factors);
            if (popupContent) {
              marker.bindPopup(popupContent, {
                className: "push-pull-popup",
                closeButton: true,
                autoPan: true,
              });

              if (index === 0) {
                firstPopupReady = true;
              }
            }
          }

          if (index === 0) {
            firstMarker = marker;
          }

          bounds.push([p.lat, p.lng]);
        });

        if (firstMarker && firstPopupReady) {
          firstMarker.openPopup();
        }

        // Draw curved arrows for each move in sequence
        for (let i = 0; i < person.places.length - 1; i++) {
          const a = person.places[i];
          const b = person.places[i + 1];
          addArcWithArrow(
            { lat: a.lat, lng: a.lng },
            { lat: b.lat, lng: b.lng },
            colors.arc
          );
        }

        // Keep map view consistent - don't auto-zoom

        // Update info panel
        document.getElementById("personName").textContent = person.name;
        document.getElementById("personDesc").textContent = person.description;
      }

      // ==========================
      // 5) RENDER ALL PEOPLE
      // ==========================

      function renderAllPeople() {
        clearLayers();

        const allBounds = [];
        const uniqueLocations = new Map(); // Track unique locations to avoid overlapping labels
        const arcCounts = new Map(); // Track how many arcs exist between city pairs

        relatives.forEach((person) => {
          // Use the person's assigned colors
          const colors = person.colors;

          // Place markers + labels for each location
          person.places.forEach((place) => {
            const locationKey = `${place.lat},${place.lng}`;

            // Only add marker with label if this location hasn't been added yet
            if (!uniqueLocations.has(locationKey)) {
              addLabeledMarker(
                place.lat,
                place.lng,
                place.name, // Just the city name, no person name
                colors.marker
              );
              uniqueLocations.set(locationKey, place.name);
            } else {
              // Add marker without label for duplicate locations
              const marker = L.circleMarker([place.lat, place.lng], {
                radius: 6,
                color: "#000",
                weight: 2,
                fillColor: colors.marker,
                fillOpacity: 1,
              }).addTo(markersGroup);
            }

            allBounds.push([place.lat, place.lng]);
          });

          // Draw curved arrows for each move in sequence
          for (let i = 0; i < person.places.length - 1; i++) {
            const a = person.places[i];
            const b = person.places[i + 1];

            // Create a consistent key for the arc regardless of direction
            const arcKey = `${Math.min(a.lat, b.lat)},${Math.min(
              a.lng,
              b.lng
            )}-${Math.max(a.lat, b.lat)},${Math.max(a.lng, b.lng)}`;

            // Get current count for this arc and increment
            const currentCount = arcCounts.get(arcKey) || 0;
            arcCounts.set(arcKey, currentCount + 1);

            // Calculate subtle offset based on arc count
            // Use smaller values for more natural looking curves
            let offset = 0;
            if (currentCount > 0) {
              // Alternating pattern with smaller increments: 0, 0.5, -0.5, 1, -1, 1.5, -1.5
              const baseOffset = Math.ceil(currentCount / 2) * 0.5;
              offset = baseOffset * (currentCount % 2 === 1 ? 1 : -1);
            }

            addArcWithArrow(
              { lat: a.lat, lng: a.lng },
              { lat: b.lat, lng: b.lng },
              colors.arc,
              offset
            );
          }
        });

        // Keep map view consistent - don't auto-zoom

        // Update info panel for all family members view
        document.getElementById("personName").textContent =
          "All Family Members";
        document.getElementById(
          "personDesc"
        ).textContent = `Showing journeys of all ${relatives.length} family members in different colors.`;
      }

      // Populate dropdown and set initial view
      const selectEl = document.getElementById("personSelect");

      // Add "Show All" option first
      const showAllOpt = document.createElement("option");
      showAllOpt.value = "all";
      showAllOpt.textContent = "Show All Family Members";
      selectEl.appendChild(showAllOpt);

      relatives.forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = p.name;
        selectEl.appendChild(opt);
      });

      selectEl.addEventListener("change", (e) => {
        const value = e.target.value;
        if (value === "all") {
          renderAllPeople();
        } else {
          const idx = Number(value);
          const person = relatives[idx];
          if (person) renderPerson(person);
        }
      });

      // Start with "Show All" option selected and a global view
      map.setView([20, 0], 2); // Centered on equator, showing whole world
      if (relatives.length > 0) {
        selectEl.value = "all";
        renderAllPeople();
      }

      // ==========================
      // 6) HOW TO ADD NEW RELATIVES
      // ==========================
      // Copy this template and append to the `relatives` array above:
      // {
      //   name: "Full Name",
      //   colors: { marker: "#hexcolor", arc: "#hexcolor" }, // Choose unique colors
      //   places: [
      //     { name: "City, Country (born)", lat: 0, lng: 0 },
      //     { name: "Move 1 City, Country", lat: 0, lng: 0 },
      //     { name: "Move 2 City, Country", lat: 0, lng: 0 },
      //     // ... add as many as needed
      //   ],
      //   description: `Write 2-6 sentences: overview of their life, why they moved, and the effect it had.`
      // }
    </script>
  </body>
</html>
